## 使用说明
### server
```
kitex -module ClyMQ -service ClyMQ operations.thrift

kitex -module ClyMQ -service ClyMQ raftoperations.thrift
```
执行上述命令，生成kitex RPC

若kitex生成的代码报错，则将go.mod中的github.com/apache/thrift v0.13.0，该成13版本

```
sh build.sh
```
执行上述命令后应该有一个output目录，其中包括编译产品。
```
sh output/bootstrap.sh
```
执行上述命令后Server开始运行
### client
```
go run client/main.go
```

## 项目逻辑
### 客户端
1. common.go
   定义了客户端所需的一些基本数据结构和一个用于获取本机MAC地址的函数。这些数据结构用于存储分区和broker的信息。
2. consumer.go
   定义了消费者的数据结构和行为，包括与 ZooKeeper 和消息队列服务器的通信，以及消息的拉取逻辑。消费者负责订阅主题和分区，从broker拉取消息，并处理发布消息和心跳检测的请求。代码中使用了读写锁来保证并发安全，并通过 Kitex 客户端与服务器进行通信。消费者还实现了服务端功能，可以接收并处理特定的请求。
3. producer.go
   定义了生产者的数据结构和行为，包括与 ZooKeeper 和消息队列服务器的通信，以及消息的推送逻辑。生产者负责创建主题和分区，设置分区状态，并将消息推送到正确的分区。代码中使用了读写锁来保证并发安全，并通过 Kitex 客户端与服务器进行通信。

### 服务端
1. client.go
   这段代码是服务端的一部分，负责管理客户端、分区和消息。它实现了客户端的心跳检测、订阅管理、消息发送和接收等功能。代码结构清晰，使用了并发控制机制来保证操作的原子性和一致性。通过 Kitex 客户端与客户端通信，并通过 ZooKeeper 客户端与 ZooKeeper 通信，实现了分布式消息队列的基本功能。
2. common.go
   这段代码定义了服务端的一些通用结构和函数，用于管理 Broker 的配置、性能指标、节点信息以及文件系统操作。代码中还包含了一些测试用的函数。整体上，这些代码为服务端提供了基础的功能支持，包括身份识别、文件操作、客户端和分区管理等功能。
3. fileio.go
   实现了消息队列服务器端的文件操作逻辑，通过封装文件操作、并发控制、错误处理和日志记录等技术手段，保证了消息的持久化存储和高效读写，是消息队列系统中的重要组成部分。
4. log.go
   实现了一个简单的日志系统，能够根据环境变量设置不同的日志详细级别，并按照特定的格式输出日志信息。日志系统是服务端开发中不可或缺的一部分，对于监控、调试和故障排查具有重要意义。
5. prafts.go
   实现了基于 Raft 协议的消息队列服务器端逻辑。它包含了 Raft 节点的创建、消息的追加、状态检查、快照发送等功能。该文件主要与 Raft 相关的操作，确保消息队列的分布式一致性和高可用性。
6. rpcserver.go
   实现了服务端的 RPC 服务器逻辑，包括处理客户端的推送和拉取请求、管理 ZooKeeper 信息、处理分区状态和副本节点等。代码使用了 Kitex 框架创建和运行 RPC 服务器实例，并通过 ZooKeeper 客户端与 ZooKeeper 通信。整体上，这些代码为服务端提供了 RPC 通信、消息推送和拉取、分区管理等功能，是服务端实现消息队列的核心部分。
7. server.go
   消息队列服务端的核心文件，负责管理服务器的生命周期、处理客户端请求、维护集群状态和保证消息的一致性。通过集成 Raft 和 ZooKeeper，实现了分布式消息队列的高可用性和可扩展性。各个函数协同工作，提供了完整的消息队列服务端功能。
8. zkserver.go
   实现了与 ZooKeeper 集成的服务端逻辑，负责管理消息队列的元数据，包括代理（brokers）、主题（topics）和分区（partitions）。ZkServer 结构体是核心，它通过 ZooKeeper 客户端与 ZooKeeper 集群通信，实现元数据的注册、更新和查询。

### zookeeper
- 实现了与 ZooKeeper 集成的逻辑，负责管理消息队列的元数据，包括代理（brokers）、主题（topics）、分区（partitions）、块（blocks）和副本（duplicates）。`ZK` 结构体是核心，通过 ZooKeeper 客户端与 ZooKeeper 集群通信，实现元数据的注册、更新、查询和删除。
